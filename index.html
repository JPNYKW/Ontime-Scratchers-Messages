<html>
	<head>
		<title>OSM v2.5.3 by YKW</title>
		<link rel="shortcut icon" href="code040fixfix.png">
	<script>
		/*
		//	HTML, JavaScript を勉強中の方の為に、
		//	コメント文を添えておきます
		*/
		
		var display,mov,first,old,yet,uicon; // 変数の宣言

		var str='Setting...'; // 文字アニメーションに表示する文字列
		var plus=new Audio(); // 増えた音
		var minus=new Audio(); // 減った音
		var prime=new Audio(); // 素数の音
		plus.src='plus.mp3';
		minus.src='minus.mp3';
		prime.src='nc156168.mp3';
		var flag=false; // 制御用
		isPrime=num=>{i=0;if(num%2==1&&num>1){for(i=2;num%i!=0;i++){console.log(0)}}return (i==num||num==2)&&num!=0};
		// 素数判定の関数　NAME=VALUE=>TODO というのは「アロー関数」と呼ばれる表記方法です。
		
		function init(){ // 読み込まれた時に起動します
			display=document.getElementById('display'); // メッセージ数を表示するエリア
			mov=document.getElementById('mov'); // 文字アニメーションを表示するエリア
		}

		function start(){ // doneが押されたら起動します
			uicon=document.getElementById('usericon'); // ユーザーアイコンを表示するエリア
			user=document.getElementById('txt').value; // 入力されたユーザー名を取得
			if(user!=null&&user!='')uicon.src=getIcon(user); // ユーザー名が空でないなら、getIcon関数を呼び出す
			mov.innerText='';
			str='Getting...';
			yet=true;
			old=null;
			flag=true;
		}
		
		icon=ID=>{return `https://cdn2.scratch.mit.edu/get_image/user/${ID}_128x128.png`}; // IDを挿入したAPIリンクを返す関数
		function getIcon(user){ // アイコンのURLを戻り値とする関数です
			rq=new XMLHttpRequest(); // XMLHttpRequestを作成
			rq.open('GET',`https://api.scratch.mit.edu/users/${user}`,false); // ユーザーAPIからデータを取得
			rq.send(null); // 空データを送信して戻り値を取得
			if(rq.readyState==4&&rq.status==200){return icon(rq.responseText.split(/\D+/g)[1]);}}
			/* ここのコードは少し複雑なので、多少長めに解説します
			// まず、rq.readyState==4&&rq.status==200はデータが正常に取得できたかを判定します
			// 取得できたらicon(rq.responseText.split(/\D+/g)[1])を返します
			// icon()は()内に入力されたIDのユーザーデータを取得するAPI関数です
			// ()内のrq.responseText.split(/\D+/g)[1]は
			// ユーザー情報の中に含まれる「連続する数字」を配列に分ける正規表現で
			// 2番目（インデックスは1）がIDにあたるので、[1]でIDを取得しています
			// 結果的に()内にはIDが入力されている事になります
			*/
		
		setInterval(function(){ // setIntervalは一定の間隔で繰り返す動作です
			if(flag){
				set=user=>`https://api.scratch.mit.edu/users/${user}/messages/count`; // カウント取得
				rq=new XMLHttpRequest();
				rq.open('GET',set(user),false);rq.send(null);
				if(rq.readyState==4&&rq.status==200){
					r='';
					(rq.responseText).match(/[0-9]/g).forEach(function(e){r+=e});
					// 上記のコードも、先ほどと同様に正規表現を利用して取得しています
					console.log(`${user}\'s messages:${r}`);
					// console.logはデバッグ用です
					if(isPrime(r)&&yet){prime.play();yet=false;} // 素数ならすっご～いを鳴らす
					if(old!=r){if(old!=null){old<r?plus.play():minus.play();}old=r;yet=true;}
					display.innerText=`${user}\'s messages:${r}`; // メッセージ数を反映
				}
			}
			mov.innerText=str.substr(0,mov.innerText.length%(str.length)+1); // 文字列アニメーション
		},500); // 500ms(ミリセカンド)で呼び出しています
</script>
	<style>
		body{
		color:#fafafa; /*文字の色を指定しています*/
		background: linear-gradient(-90deg, #FFC342, #FFCD41, #FFEF41); /*背景のグラデーションです*/
		}
		/*ここから下は一番下のYKWにマウスオーバーした時などの色の変化です*/
		a:link{color: #3FFAFF;}
		a:visited{color:#3188C6;}
		a:hover{color:#FFF054;}
		a:active{color:#FF8223;}
	</style>
</head>

<body onload="init()">
	<center>
		<h1>Ontime Scratchers Messages - OSM v2.5.3</h1>
		UserName:<input type="text" id="txt" value="">
		<input type="button" value="done" onclick="start();"><br><br>
		<img src='noImage.png' id='usericon' width="128px" height="128px"></img><br>
		<h1 id='display'>NONAME's messages:0</h1>
		<h1 id="mov">-</h1><br>
		<img src="code040fixfix.png" onclick="window.open('https://scratch.mit.edu/users/youkaiwatch')"></img><br>
		&spades; It works by <a href="https://scratch.mit.edu/users/youkaiwatch" target="_blank">YKW</a>
	</center>
</body>
</html>
